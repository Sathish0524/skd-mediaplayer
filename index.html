<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SKD Media Player - Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; background:#0b1020; color:#f5f5f5; margin:0; }
    header { padding:15px 20px; background:#141b34; box-shadow:0 2px 4px rgba(0,0,0,.4); position:sticky; top:0; z-index:10; }
    header h1 { margin:0; font-size:22px; letter-spacing:1px; }
    main { display:flex; flex-wrap:wrap; padding:15px; gap:15px; }
    .controls, .playlist, .player { background:#161d36; border-radius:8px; padding:15px; box-sizing:border-box; }
    .controls { flex:1 1 100%; }
    .playlist { flex:1 1 260px; max-height:450px; overflow:hidden; }
    .player { flex:2 1 320px; }
    label { display:block; margin-bottom:6px; font-size:14px; }
    input[type="text"], input[type="search"] { width:100%; padding:8px 10px; border-radius:4px; border:1px solid #2c3458; background:#0b1020; color:#f5f5f5; box-sizing:border-box; }
    button { margin:4px 4px 4px 0; padding:8px 14px; border:none; border-radius:4px; background:#1f8bff; color:#fff; cursor:pointer; font-weight:600; font-size:13px; }
    button:hover { background:#166bd0; }
    button:disabled { background:#4a5568; cursor:not-allowed; opacity:0.6; }
    button.danger { background:#ff4757; }
    button.danger:hover { background:#ff3742; }
    button.success { background:#2ed573; }
    button.success:hover { background:#26b660; }
    .playlist-tabs { display:flex; gap:3px; margin-bottom:10px; flex-wrap:wrap; }
    .tab { padding:6px 10px; background:#242b4a; border-radius:4px 4px 0 0; cursor:pointer; font-size:12px; border:1px solid #2c3458; }
    .tab.active { background:#1f8bff; color:#fff; border-bottom-color:#1f8bff; }
    .playlist-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
    ul { list-style:none; padding:0; margin:0; max-height:350px; overflow-y:auto; }
    li { padding:8px 10px; border-bottom:1px solid #242b4a; cursor:pointer; font-size:14px; display:flex; justify-content:space-between; align-items:center; }
    li:hover { background:#1f2745; }
    li.active { background:#1f8bff; color:#fff; }
    .type-badge { font-size:11px; padding:2px 6px; border-radius:3px; background:#2c3458; }
    .video-container { position: relative; background: #000; border-radius: 8px; overflow: hidden; height: 60vh; }
    video, audio { width:100%; height:100%; background:#000; display:block; object-fit: cover; }
    .player-overlay { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.9)); padding: 20px 15px 15px; opacity: 0; transition: opacity 0.3s; }
    .video-container:hover .player-overlay { opacity: 1; }
    .status { margin-top:8px; font-size:12px; color:#bbb; padding:6px; background:#1a2238; border-radius:4px; }
    .playlist-actions { display:flex; gap:5px; flex-wrap:wrap; margin:10px 0; }
    #debug { background:#1a2238; padding:10px; border-radius:4px; font-size:12px; margin-top:10px; max-height:100px; overflow-y:auto; }
    @media (max-width:768px) { main { flex-direction:column; } .playlist { order:3; } .video-container { height: 50vh; } }
  </style>
</head>
<body>
<header><h1>üé¨ SKD Media Player - Pro</h1></header>
<main>
  <section class="controls">
    <label for="playlistName">Playlist Name:</label>
    <input type="text" id="playlistName" placeholder="Enter playlist name..." value="Live Tv">
    <label for="m3uUrl">M3U URL:</label>
    <input type="text" id="m3uUrl" value="https://iptv-org.github.io/iptv/index.m3u">
    
    <div class="playlist-actions">
      <button id="loadBtn">üîÑ Load Playlist</button>
      <button id="saveBtn" class="success" disabled>üíæ Save</button>
      <button id="deleteBtn" class="danger" style="display:none;">üóëÔ∏è Delete</button>
    </div>
    
    <div class="playlist-actions">
      <button id="loadLiveTv" class="success">üì∫ Load Live TV</button>
      <button id="loadTamil" class="success">üáÆüá≥ Load Tamil Local</button>
    </div>
    
    <div class="status" id="statusText">Ready - Use buttons or Load Playlist</div>
    <div id="debug"></div>
  </section>
  <section class="playlist">
    <div class="playlist-header">
      <h3>Channels (<span id="channelCount">0</span>)</h3>
      <button id="clearAllBtn" class="danger" style="font-size:12px;padding:4px 8px;">Clear All</button>
    </div>
    <div class="playlist-tabs" id="playlistTabs"></div>
    <input type="search" id="channelSearch" placeholder="üîç Search channels..." style="margin-bottom:10px;">
    <ul id="playlistList"></ul>
  </section>
  <section class="player">
    <h3>Now Playing</h3>
    <div class="video-container" id="videoContainer">
      <video id="videoPlayer" controls playsinline muted></video>
      <audio id="audioPlayer" controls style="display:none;"></audio>
      <div class="player-overlay"></div>
    </div>
    <div id="nowPlaying" class="status"></div>
  </section>
</main>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
let playlists = {}, currentPlaylistId = null, currentEntries = [], loadedEntries = [], hlsInstance = null, userId = null, displayEntries = [];

const PRESET_PLAYLISTS = {
  'livetv': {
    name: 'Live Tv',
    url: 'https://iptv-org.github.io/iptv/index.m3u'
  },
  'tamil': {
    name: 'Tamil Local Channels',
    url: 'https://tinyurl.com/amaze-tamil-local-tv'
  }
};

const elements = {
  loadBtn: document.getElementById('loadBtn'),
  saveBtn: document.getElementById('saveBtn'),
  deleteBtn: document.getElementById('deleteBtn'),
  clearAllBtn: document.getElementById('clearAllBtn'),
  loadLiveTv: document.getElementById('loadLiveTv'),
  loadTamil: document.getElementById('loadTamil'),
  m3uUrl: document.getElementById('m3uUrl'),
  playlistName: document.getElementById('playlistName'),
  channelSearch: document.getElementById('channelSearch'),
  playlistList: document.getElementById('playlistList'),
  playlistTabs: document.getElementById('playlistTabs'),
  statusText: document.getElementById('statusText'),
  debug: document.getElementById('debug'),
  channelCount: document.getElementById('channelCount'),
  videoPlayer: document.getElementById('videoPlayer'),
  audioPlayer: document.getElementById('audioPlayer'),
  nowPlaying: document.getElementById('nowPlaying'),
  videoContainer: document.getElementById('videoContainer')
};

init();

function init() {
  userId = 'user_' + Date.now();
  loadSavedPlaylists();
  setupEventListeners();
  updateUI();
  loadPresetPlaylists();
}

function loadPresetPlaylists() {
  Object.entries(PRESET_PLAYLISTS).forEach(([id, data]) => {
    if (!playlists[id]) {
      playlists[id] = {
        name: data.name,
        entries: [],
        url: data.url,
        timestamp: Date.now(),
        isPreset: true
      };
    }
  });
  savePlaylists();
  renderPlaylistTabs();
}

function loadSavedPlaylists() {
  try {
    const saved = localStorage.getItem(`skd_playlists_${userId}`);
    if (saved) {
      playlists = JSON.parse(saved);
    }
  } catch (e) { 
    playlists = {}; 
  }
}

function savePlaylists() {
  localStorage.setItem(`skd_playlists_${userId}`, JSON.stringify(playlists));
}

function log(msg) {
  console.log(msg);
  elements.debug.innerHTML += msg + '<br>';
  elements.debug.scrollTop = elements.debug.scrollHeight;
}

function setupEventListeners() {
  elements.loadBtn.onclick = loadPlaylistUrl;
  elements.loadLiveTv.onclick = () => loadPreset('livetv');
  elements.loadTamil.onclick = () => loadPreset('tamil');
  elements.saveBtn.onclick = saveCurrentPlaylist;
  elements.deleteBtn.onclick = deleteCurrentPlaylist;
  elements.clearAllBtn.onclick = clearAllPlaylists;
  elements.channelSearch.oninput = debounce(filterChannels, 200);
}

function loadPreset(id) {
  const preset = PRESET_PLAYLISTS[id];
  if (preset) {
    elements.playlistName.value = preset.name;
    elements.m3uUrl.value = preset.url;
    loadPlaylistUrl();
  }
}

function debounce(fn, delay) {
  let timeout;
  return function() {
    clearTimeout(timeout);
    timeout = setTimeout(() => fn.apply(this, arguments), delay);
  };
}

function showStatus(msg, type = '') {
  elements.statusText.textContent = msg;
  elements.statusText.className = `status ${type}`;
}

function loadPlaylistUrl() {
  const url = elements.m3uUrl.value.trim();
  if (!url) return showStatus('Enter M3U URL', 'error');
  
  elements.loadBtn.disabled = true;
  showStatus('Loading playlist...');
  elements.debug.innerHTML = '';
  
  fetch(url)
    .then(res => {
      log(`‚úÖ HTTP ${res.status}`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.text();
    })
    .then(text => {
      log(`üìÑ Got ${text.length.toLocaleString()} characters`);
      const entries = parseM3U(text, url);
      log(`‚úÖ Parsed ${entries.length.toLocaleString()} channels`);
      loadedEntries = entries;
      currentEntries = entries;
      displayEntries = entries;
      elements.playlistName.value = `${entries.length.toLocaleString()} channels loaded`;
      elements.saveBtn.disabled = false;
      renderPlaylist(displayEntries);
      elements.channelCount.textContent = displayEntries.length;
      showStatus(`‚úÖ ${entries.length.toLocaleString()} channels loaded!`, 'success');
    })
    .catch(err => {
      log(`‚ùå ERROR: ${err.message}`);
      showStatus(`‚ùå ${err.message}`, 'error');
    })
    .finally(() => elements.loadBtn.disabled = false);
}

function parseM3U(text, baseUrl) {
  const lines = text.split('\n');
  const entries = [];
  let i = 0;
  
  while (i < lines.length) {
    const line = lines[i].trim();
    if (line.startsWith('#EXTINF:')) {
      const commaPos = line.indexOf(',');
      let title = 'Unknown Channel';
      if (commaPos !== -1) {
        title = line.substring(commaPos + 1).replace(/"/g, '').trim();
      }
      
      i++;
      if (i < lines.length) {
        let urlLine = lines[i].trim();
        if (urlLine && !urlLine.startsWith('#')) {
          try {
            const url = new URL(urlLine.startsWith('http') ? urlLine : baseUrl + '/' + urlLine, baseUrl).href;
            entries.push({ title, url, type: 'video' });
          } catch (e) {
            // Skip invalid URLs
          }
        }
      }
    }
    i++;
  }
  return entries;
}

function filterChannels() {
  const term = elements.channelSearch.value.toLowerCase().trim();
  if (!term) {
    displayEntries = currentEntries.slice();
  } else {
    displayEntries = currentEntries.filter(item => 
      item.title.toLowerCase().includes(term)
    );
  }
  log(`üîç Search "${term}": ${displayEntries.length} results`);
  renderPlaylist(displayEntries);
  elements.channelCount.textContent = displayEntries.length;
}

function saveCurrentPlaylist() {
  const name = elements.playlistName.value.trim() || `Playlist ${Date.now()}`;
  const id = 'p' + Date.now();
  playlists[id] = { name, entries: [...loadedEntries], url: elements.m3uUrl.value, timestamp: Date.now() };
  currentPlaylistId = id;
  savePlaylists();
  updateUI();
  showStatus(`‚úÖ "${name}" saved!`, 'success');
}

function deleteCurrentPlaylist() {
  if (!currentPlaylistId || !confirm('Delete playlist?')) return;
  delete playlists[currentPlaylistId];
  currentPlaylistId = null;
  savePlaylists();
  updateUI();
  showStatus('‚úÖ Deleted', 'success');
}

function clearAllPlaylists() {
  if (!Object.keys(playlists).length || !confirm('Delete ALL playlists?')) return;
  playlists = {};
  currentPlaylistId = null;
  savePlaylists();
  updateUI();
  showStatus('‚úÖ Cleared', 'success');
}

function updateUI() {
  elements.channelCount.textContent = displayEntries.length || 0;
  renderPlaylistTabs();
  elements.deleteBtn.style.display = currentPlaylistId ? 'inline-block' : 'none';
  elements.saveBtn.disabled = !loadedEntries.length;
  if (displayEntries.length) renderPlaylist(displayEntries);
  if (currentPlaylistId) elements.playlistName.value = playlists[currentPlaylistId].name;
}

function renderPlaylistTabs() {
  elements.playlistTabs.innerHTML = '';
  Object.entries(playlists).sort(([,a], [,b]) => b.timestamp - a.timestamp).forEach(([id, data]) => {
    const tab = document.createElement('div');
    tab.className = `tab ${id === currentPlaylistId ? 'active' : ''}`;
    const displayName = data.name.length > 12 ? data.name.slice(0, 12) + '...' : data.name;
    tab.textContent = displayName;
    tab.title = `${data.name} (${data.entries.length || 0}) ${data.isPreset ? '[PRESET]' : ''}`;
    tab.onclick = () => switchPlaylist(id);
    elements.playlistTabs.appendChild(tab);
  });
}

function switchPlaylist(id) {
  const playlist = playlists[id];
  currentPlaylistId = id;
  elements.playlistName.value = playlist.name;
  
  if (playlist.entries && playlist.entries.length > 0) {
    currentEntries = [...playlist.entries];
    displayEntries = currentEntries.slice();
    loadedEntries = [];
    elements.saveBtn.disabled = true;
    renderPlaylist(displayEntries);
    showStatus(`‚úÖ "${playlist.name}" loaded`);
  } else if (playlist.url) {
    elements.m3uUrl.value = playlist.url;
    loadPlaylistUrl();
  }
}

let currentActiveIndex = -1;
function renderPlaylist(entries) {
  elements.playlistList.innerHTML = '';
  entries.slice(0, 200).forEach((item, index) => {
    const li = document.createElement('li');
    li.innerHTML = `<span>${item.title}</span><span class="type-badge">VIDEO</span>`;
    li.onclick = () => playItem(item, index);
    if (index === currentActiveIndex) li.classList.add('active');
    elements.playlistList.appendChild(li);
  });
  elements.channelCount.textContent = entries.length;
}

function playItem(item, index) {
  currentActiveIndex = index;
  Array.from(elements.playlistList.children).forEach((li, i) => {
    li.classList.toggle('active', i === index);
  });
  elements.nowPlaying.textContent = `‚ñ∂ ${item.title}`;
  
  elements.audioPlayer.pause();
  elements.audioPlayer.style.display = 'none';
  elements.videoPlayer.style.display = 'block';
  playVideo(item.url);
}

function playVideo(src) {
  stopHls();
  const video = elements.videoPlayer;
  video.pause();
  video.src = '';
  video.load();
  video.src = src;
  video.load();
  setTimeout(() => video.play().catch(e => console.error('Play failed:', e)), 500);
}

function stopHls() {
  if (hlsInstance) {
    hlsInstance.destroy();
    hlsInstance = null;
  }
}
</script>
</body>
</html>
